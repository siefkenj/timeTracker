// Generated by CoffeeScript 1.9.0

/*
 * Helper Functions
 */
var END_TIME, START_TIME, adjustableRangeDirective, app, createFakeHangoutData, createHourList, formatName, getTotalHours, randRange, randSample, roundToHalf, timeColumnDirective, timeRangeToClassName, timeviewController,
  __modulo = function(a, b) { return (+a % (b = +b) + b) % b; };

randRange = function(start, end) {
  if (start == null) {
    start = 0;
  }
  if (end == null) {
    end = 5;
  }
  return start + Math.floor(Math.random() * (end - start + 1));
};

randSample = function(array, samples) {
  var arrayCpy, i, ret, _i;
  arrayCpy = array.slice();
  ret = [];
  for (i = _i = 0; 0 <= samples ? _i < samples : _i > samples; i = 0 <= samples ? ++_i : --_i) {
    ret = ret.concat(arrayCpy.splice(randRange(0, arrayCpy.length - 1), 1));
  }
  return ret;
};

createFakeHangoutData = function(start, end, people) {
  var curr, day, endT, hangouts, numHangouts, person, ret, segments, startT, todaysHangouts, _i, _len;
  if (start == null) {
    start = new Date(2015, 1, 1);
  }
  if (end == null) {
    end = new Date(2016, 1, 1);
  }
  if (people == null) {
    people = ['Andrei', 'Andrew', 'Jonah', 'Paul'];
  }
  ret = {};
  curr = new Date(start);
  while (curr <= end) {
    todaysHangouts = {};
    numHangouts = randRange(0, people.length);
    hangouts = randSample(people, numHangouts);
    for (_i = 0, _len = hangouts.length; _i < _len; _i++) {
      person = hangouts[_i];
      day = [];
      segments = randRange(1, 2);
      if (segments > 1) {
        startT = randRange(0, 23);
        endT = randRange(startT + 1, 24);
        day.push({
          start: startT / 2,
          end: endT / 2
        });
        startT = randRange(endT + 1, 48);
        endT = randRange(startT + 1, 48);
        day.push({
          start: startT / 2,
          end: endT / 2
        });
      } else {
        startT = randRange(0, 48);
        endT = randRange(startT + 1, 48);
        day.push({
          start: startT / 2,
          end: endT / 2
        });
      }
      todaysHangouts[person] = {
        name: person,
        times: day
      };
    }
    ret[curr] = todaysHangouts;
    curr.setDate(curr.getDate() + 1);
  }
  return ret;
};

roundToHalf = function(t) {
  return Math.round(2 * t) / 2;
};

createHourList = function(start, end) {
  var hour, i, today;
  if (start == null) {
    start = -2;
  }
  if (end == null) {
    end = 24 + 4;
  }
  today = function(t) {
    if ((0 <= i && i <= 24)) {
      return "today";
    } else {
      return "not-today";
    }
  };
  hour = function(t) {
    return "" + (__modulo(t, 12) === 0 ? 12 : __modulo(t, 12)) + (__modulo(t, 24) >= 12 ? 'pm' : 'am');
  };
  return (function() {
    var _i, _results;
    _results = [];
    for (i = _i = start; start <= end ? _i < end : _i > end; i = start <= end ? ++_i : --_i) {
      _results.push({
        thisday: today(i),
        hour: hour(i)
      });
    }
    return _results;
  })();
};

getTotalHours = function(p) {
  var t, total, _i, _len, _ref;
  total = 0;
  _ref = p.times;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    t = _ref[_i];
    total += t.end - t.start;
  }
  return total;
};

timeRangeToClassName = function(t) {
  var formatNum, len, start;
  formatNum = function(x) {
    if (__modulo(x, 1) > 0) {
      return (Math.floor(x)) + "-5";
    } else {
      return (Math.floor(x)) + "-0";
    }
  };
  len = roundToHalf(t.end - t.start);
  start = roundToHalf(t.start);
  return "length-" + (formatNum(len)) + " start-" + (formatNum(start));
};

formatName = function(person) {
  return person.name + " (" + (getTotalHours(person)) + ")";
};

START_TIME = -2;

END_TIME = 24 + 3;


/*
 * START OF THE APP
 */

app = angular.module('dayviewControllers', []);


/*
 * TimeViewController
 */

timeviewController = function($scope, $routeParams, dataService) {
  $scope.getTotalHours = getTotalHours;
  $scope.timeRangeToClassName = timeRangeToClassName;
  $scope.formatName = formatName;
  $scope.hours = createHourList(START_TIME, END_TIME);
  console.log($scope.people);
  console.log('route params', $routeParams);
  dataService.get($routeParams.year, $routeParams.month, $routeParams.day).then(function(dayData) {
    $scope.people = dayData;
    return console.log('set people to', dayData);
  });
  window.xxx = dataService;
};

adjustableRangeDirective = function() {
  return {
    link: function(scope, elm, attrs) {
      var oldHourChange, origTimeEnd, origTimeStart, startY;
      oldHourChange = null;
      startY = null;
      origTimeStart = scope.time.start;
      origTimeEnd = scope.time.end;
      interact($(elm).find('.top-handle')[0]).draggable({
        max: Infinity
      }).on('dragstart', function(evt) {
        startY = evt.pageY;
        return origTimeStart = scope.time.start;
      }).on('dragmove', function(evt) {
        var delta, hourChange;
        delta = startY - evt.pageY;
        hourChange = roundToHalf(delta / 23);
        if (hourChange !== oldHourChange) {
          oldHourChange = hourChange;
          scope.time.start = origTimeStart - hourChange;
          return scope.$apply();
        }
      });
      return interact($(elm).find('.bottom-handle')[0]).draggable({
        max: Infinity
      }).on('dragstart', function(evt) {
        startY = evt.pageY;
        return origTimeEnd = scope.time.end;
      }).on('dragmove', function(evt) {
        var delta, hourChange;
        delta = startY - evt.pageY;
        hourChange = roundToHalf(delta / 23);
        if (hourChange !== oldHourChange) {
          oldHourChange = hourChange;
          scope.time.end = origTimeEnd - hourChange;
          return scope.$apply();
        }
      });
    }
  };
};

timeColumnDirective = function() {
  return {
    link: function(scope, elm, attrs) {
      return console.log('linking!!', scope.person);
    }
  };
};

app.controller('TimeViewController', ['$scope', '$routeParams', 'dataService', timeviewController]);

app.directive('adjustableRange', adjustableRangeDirective);

app.directive('timeColumn', adjustableRangeDirective);
