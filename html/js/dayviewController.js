// Generated by CoffeeScript 1.9.0

/*
 * Helper Functions
 */
var END_TIME, START_TIME, adjustableRangeDirective, app, createHourList, getTotalHours, roundToHalf, timeRangeToClassName, timeviewController,
  __modulo = function(a, b) { return (+a % (b = +b) + b) % b; };

roundToHalf = function(t) {
  return Math.round(2 * t) / 2;
};

createHourList = function(start, end) {
  var hour, i, today;
  if (start == null) {
    start = -2;
  }
  if (end == null) {
    end = 24 + 4;
  }
  today = function(t) {
    if ((0 <= i && i <= 24)) {
      return "today";
    } else {
      return "not-today";
    }
  };
  hour = function(t) {
    return "" + (__modulo(t, 12) === 0 ? 12 : __modulo(t, 12)) + (__modulo(t, 24) >= 12 ? 'pm' : 'am');
  };
  return (function() {
    var _i, _results;
    _results = [];
    for (i = _i = start; start <= end ? _i < end : _i > end; i = start <= end ? ++_i : --_i) {
      _results.push({
        thisday: today(i),
        hour: hour(i)
      });
    }
    return _results;
  })();
};

getTotalHours = function(p) {
  var t, total, _i, _len, _ref;
  total = 0;
  _ref = p.times;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    t = _ref[_i];
    total += t.end - t.start;
  }
  return total;
};

timeRangeToClassName = function(t) {
  var formatNum, len, start;
  formatNum = function(x) {
    if (__modulo(x, 1) > 0) {
      return (Math.floor(x)) + "-5";
    } else {
      return (Math.floor(x)) + "-0";
    }
  };
  len = roundToHalf(t.end - t.start);
  start = roundToHalf(t.start);
  return "length-" + (formatNum(len)) + " start-" + (formatNum(start));
};

START_TIME = -2;

END_TIME = 24 + 3;


/*
 * START OF THE APP
 */

app = angular.module('App', []);


/*
 * TimeViewController
 */

timeviewController = function($scope) {
  var k, v;
  $scope.people = {
    person1: {
      name: 'Andrei',
      times: [
        {
          start: 7,
          end: 14
        }, {
          start: 22,
          end: 26
        }
      ]
    },
    person2: {
      name: 'Jonah',
      times: [
        {
          start: 16,
          end: 18.5
        }
      ]
    }
  };
  $scope.getTotalHours = getTotalHours;
  $scope.timeRangeToClassName = timeRangeToClassName;
  $scope.hours = createHourList(START_TIME, END_TIME);
  $scope.names = (function() {
    var _ref, _results;
    _ref = $scope.people;
    _results = [];
    for (k in _ref) {
      v = _ref[k];
      _results.push(v.name + " (" + (getTotalHours(v)) + ")");
    }
    return _results;
  })();
  console.log($scope.names, $scope.people);
};

adjustableRangeDirective = function() {
  return {
    link: function(scope, elm, attrs) {
      var oldHourChange, origTimeEnd, origTimeStart, startY;
      oldHourChange = null;
      startY = null;
      origTimeStart = scope.time.start;
      origTimeEnd = scope.time.end;
      interact($(elm).find('.top-handle')[0]).draggable({
        max: Infinity
      }).on('dragstart', function(evt) {
        startY = evt.pageY;
        return origTimeStart = scope.time.start;
      }).on('dragmove', function(evt) {
        var delta, hourChange;
        delta = startY - evt.pageY;
        hourChange = roundToHalf(delta / 23);
        if (hourChange !== oldHourChange) {
          oldHourChange = hourChange;
          scope.time.start = origTimeStart - hourChange;
          return scope.$apply();
        }
      });
      return interact($(elm).find('.bottom-handle')[0]).draggable({
        max: Infinity
      }).on('dragstart', function(evt) {
        startY = evt.pageY;
        return origTimeEnd = scope.time.end;
      }).on('dragmove', function(evt) {
        var delta, hourChange;
        delta = startY - evt.pageY;
        hourChange = roundToHalf(delta / 23);
        if (hourChange !== oldHourChange) {
          oldHourChange = hourChange;
          scope.time.end = origTimeEnd - hourChange;
          return scope.$apply();
        }
      });

      /*
      $(elm).find('.top-handle').click (evt, elm) ->
          console.log evt, elm
          scope.time.start -= .5
          scope.$apply()
      $(elm).find('.bottom-handle').click (evt, elm) ->
          console.log evt, elm
          scope.time.end += .5
          scope.$apply()
       */
    }
  };
};

app.controller('TimeViewController', ['$scope', timeviewController]);

app.directive('adjustableRange', adjustableRangeDirective);
